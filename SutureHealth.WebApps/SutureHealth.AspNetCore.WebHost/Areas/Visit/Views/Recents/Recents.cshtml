@using SutureHealth.AspNetCore.WebHost.Areas.Visit.Models
@model BaseViewModel
@{

    ViewBag.Title = "Video Recents";
    Layout = "_Layout";

    Model.RequireUI = true;
    Model.RequireKendo = true;
}
@section Styles
{
<style>
    .view-visit-container {
        padding: 20px;
    }

    .add-new-visit {
        font-size: 22px;
    }

    td {
        border-right:none !important;
        border-left: none !important;
    }
</style>
}
<link rel="stylesheet" href="~/css/RecentsVideo.min.css" />


<section class="mt-3">
    <div class="container-fluid">
        <div class="row">
            <div class="col-12 col-md-6">
                <h4 class="mb-0 text-start"> Recents <span class="small text-secondary">(All times in local time)</span></h4>


            </div>
            <div class="col-12 col-md-6 align-self-center">
                <p class="text-end lead pt-2">
                    <a asp-area="Visit" asp-controller="Visit" asp-action="Index" style="text-decoration: none;color: #1e6be8;">
                        <i class="fa fa-plus-circle" aria-hidden="true"></i>
                        <span class="">New Video Visit</span>
                    </a>
                </p>
            </div>

        </div>
        <div class="row">
            <div class="col-12">
                <hr class="mt-0">
            </div>
        </div>
    </div>
</section>
<div class="sh-background-box">
    <div class="view-visit-container ">
        
        <div class="row">
            <div class="col-md-12 div-distance">
                @(
                    Html.Kendo().Grid<Visit>()
                                .Name("viewVisitsGrid")
                                .DataSource(datasource => 
                                {
                                    datasource.Ajax()
                                              .PageSize(15)
                                              .Read(r => r.Action<SutureHealth.AspNetCore.WebHost.Areas.Visit.Controllers.RecentsController>(c => c.GetUserVisitsData(null)));
                                })
                                .Columns(column => 
                                {
                                    column.Bound(v => v.CreatedAt)
                                          .Filterable(filter => filter.Cell(cell => cell.Template("window.RecentVisits.initializeCreatedAtFilterTemplate")))
                                          .Format("{0:MM/dd/yyyy}")
                                          .Sortable(true)
                                          .Title("Date")
                                          .Width(190);
                                    column.Bound(v => v.CreatedAt)
                                          .Filterable(false)
                                          .Sortable(false)
                                          .ClientTemplate("#=kendo.toString(kendo.parseDate(CreatedAt), \"t\")#")
                                          .Title("Time")
                                          .Width(130);
                                    column.Bound(v => v.ParticipantPhoneNumber)
                                          .Filterable(filter => filter.Cell(cell => cell.Operator("contains").SuggestionOperator(FilterType.Contains))
                                                                      .Mode(GridFilterMode.Row))
                                          .Title("Number")
                                          .Sortable(false)
                                          .Width(400);
                                    column.Bound(v => v.PatientName).Filterable(false).Sortable(false).Width(400);
                                    column.Bound(v => v.TotalMinutes)
                                          .ClientHeaderTemplate("<span data-toggle='tooltip' class='sh-tooltip' title='Sum of all participant time, including wait times.'>Participant Time (minutes) <i class='fa fa-info-circle'></i></span>")
                                          .Filterable(false)
                                          .Title("Participant Time (minutes)")
                                          .Width(250);
                                    column.Bound(v => v.BillableMinutes).Filterable(false).Title("Duration (minutes)").Width(180);
                                })
                                .ColumnMenu()
                                .Pageable(paging => paging.PageSizes(new [] { 15, 30, 50 }).Refresh(true))
                                .Sortable()
                                .Filterable(filter => filter.Mode(GridFilterMode.Row))
                                .Resizable(resize => resize.Columns(true))
                                .Excel(excel => excel.AllPages(true).FileName($"{DateTime.Now.ToString("yyyy-MM-dd")}_SutureHealth_Video_Visits"))
                                .ToolBar(toolbar => {
                                    toolbar.Excel().Text("Export").HtmlAttributes(new { @class = " floatedButton k-grid-excel k-toggle-button k-button k-button-md k-button-rectangle k-rounded-md k-button-solid k-button-solid-base"});
                                })
                )
            </div>
        </div>
    </div>
</div>

<template id="dateFilterTemplate">
    <span style="width:100%"><input class="from-date date-picker" placeholder="From" /><button type="button" class="k-button k-button-icon calendar-from-clear-button" style="display: none;margin-right: 6.8em;"><span class="k-icon k-i-close"></span></button></span>
    <span style="width:100%"><input class="thru-date date-picker" placeholder="To" /><button type="button" class="k-button k-button-icon calendar-thru-clear-button" style="display: none;margin-right:6.8em;"><span class="k-icon k-i-close"></span></button></span>    
</template>
<script type="text/javascript">

    (function(window, undefined)
    {
        class RecentVisits
        {
            initializeCreatedAtFilterTemplate(args)
            {
                var gridContainer = $("#viewVisitsGrid");
                var templateText = $("#dateFilterTemplate")[0].innerHTML;

                var filterCell = args.element.parents(".k-filtercell");
                filterCell.empty();
                filterCell.html(templateText);

                // var fromClearButton = $("button.calendar-from-clear-button")[0];
                // var thruClearButton = $("button.calendar-thru-clear-button")[0];
                // $(fromClearButton).click(function(e) { onCleanDateFilter(e.target); });
                // $(thruClearButton).click(function(e) { onCleanDateFilter(e.target); });

                

                gridContainer.on("click", "#addNewVisit", function(e) {
                    e.preventDefault();

                    window.location = "@(Url.Action("Index", "Visit"))";
                });

                function onCleanDateFilter(e) {
                    $(e).css('display', 'none');
                    if (e == fromClearButton) {
                        $('.calendar-start-clear-button').css('display', 'none');
                        $($(e).closest("[data-field]").find('.from-date')[1]).data("kendoDatePicker").value("");
                        $($(e).closest("[data-field]").find('.from-date')[1]).data("kendoDatePicker").trigger("change");
                    }
                    else if (e == thruClearButton)
                    {
                        $('.calendar-end-clear-button').css('display', 'none');
                        $($(e).closest("[data-field]").find('.thru-date')[1]).data("kendoDatePicker").value("");
                        $($(e).closest("[data-field]").find('.thru-date')[1]).data("kendoDatePicker").trigger("change");
                    }
                }

                function removeFilter(filter, searchFor, operator) {
                    for (var x = 0; x < filter.length; x++) {
                        if (filter[x].field === searchFor && filter[x].operator === operator) {
                            filter.splice(x, 1);
                            return removeFilter(filter, searchFor);
                        }
                    }
                    return filter;
                }

                $(".date-picker", filterCell).kendoDatePicker({
                    change: function (e) {
                        var fromDate = $("input.from-date", filterCell).data("kendoDatePicker").value(),
                            thruDate = $("input.thru-date", filterCell).data("kendoDatePicker").value(),
                            dataSource = gridContainer.data("kendoGrid").dataSource,
                            filter = dataSource.filter();

                        // push the filters to the grid from the date pickers
                        if (!filter) filter = { logic: "and", filters: [] };
                        filter.filters = removeFilter(filter.filters, 'CreatedAt', 'gte');
                        filter.filters = removeFilter(filter.filters, 'CreatedAt', 'lte');
                        if (fromDate) filter.filters.push({ field: "CreatedAt", operator: "gte", value: fromDate });
                        if (thruDate) filter.filters.push({ field: "CreatedAt", operator: "lte", value: new Date(thruDate.setDate(thruDate.getDate() + 1)) });
                        dataSource.filter(filter);

                        e.sender.element.siblings(".k-select").find(".k-link.k-link-clear").toggle(e.sender.value() != null);
                        // enable the clear buttons
                        // if (fromDate) $(fromClearButton).css('display', 'block');
                        // if (thruDate) $(thruClearButton).css('display', 'block');
                    },
                    max: new Date(),
                    format: 'M/d/yyyy'
                }).data("kendoDatePicker");
            }
        }

        window.RecentVisits = new RecentVisits();

    })(this);

    $(document).ready(function() {
        console.log("creating clear buttons, length of k-select items: " + $(".k-datepicker .k-picker-wrap .k-select").length);
        var clearButton = '<span class="k-link k-link-clear" style="display:none;position:absolute;margin-right:25px;right:10px;" aria-label="Clear the DateTimePicker"><span unselectable="on" class="k-icon k-i-close" aria-controls="dtp_timeview"></span></span>';
               
        $(".k-datepicker .k-picker-wrap .k-select").prepend(clearButton);

        $(".k-link.k-link-clear").on("click", function (e) {
            var dtp = $(e.target).closest(".k-datepicker").find("input[data-role='datepicker']").data("kendoDatePicker");
            dtp.value("");
            dtp.trigger("change");
        });
    });
</script>
