@model SutureHealth.AspNetCore.Areas.Admin.Models.Member.SearchModel
@{
    Model.RequireUI = true;
    Model.RequireKendo = true;
}

@section Styles
    {
    <link rel="stylesheet" href="~/css/AdminStyle.min.css" asp-append-version="true" />
}

    <section class="mt-2">
        <div class="container-fluid">
            <div class="row">
                <div class="col-11">
                    <div class="row">
                        <div class="col-1">
                            <h2 style="font-weight: bold;">
                                Users
                            </h2>
                        </div>
                        <div class="col-4 align-self-center">
                            <button class="btn btn-outline-primary" id="AddNewMember" type="button">Add New User</button>
                            <button class="btn btn-outline-primary" id="ExcelExport" type="button">Export Grid</button>
                        </div>
                    </div>
                    <hr class="mt-0" />
                </div>
            </div>
        </div>
    </section>

    <section class="pb-3">
        <div class="container-fluid">
            <div class="row justify-content-center mb-3">
                <div id="filter-box" class="col-5 bg-light p-3 shadow">
                    <span style="font-weight: bold"><i class="fas  fa-search" style="color: var(--suture-blue);"></i> Filter by Organization:</span>
                    <kendo-combobox name="OrganizationFilter" auto-bind="false" filter="FilterType.Contains" min-length="2" enforce-min-length="true" datavaluefield="OrganizationId" datatextfield="Name" on-change="onOrganizationFilterChange">
                        <datasource type="DataSourceTagHelperType.Ajax" server-operation="true" server-filtering="true">
                            <transport>
                                <read url="@Model.OrganizationDataSourceUrl" type="POST" />
                            </transport>
                        </datasource>
                    </kendo-combobox>
                </div>
            </div>
            <div class="row justify-content-center">
                <div class="col-11">
                    <kendo-grid name="Members" resizable="true" detail-template-id="MemberDetail" on-detail-init="onDetailInit">
                        <datasource type="DataSourceTagHelperType.Ajax" server-operation="true" server-filtering="true" server-sorting="true" page-size="30">
                            <sorts>
                                <sort field="LastName" direction="asc" />
                            </sorts>
                            <schema>
                                <model id="MemberId">
                                    <fields>
                                        <field name="MemberId" type="string" />
                                        <field name="FirstName" type="" />
                                        <field name="LastName" type="" />
                                        <field name="UserName" type="" />
                                        <field name="Email" type="" />
                                        <field name="MemberTypeId" type="string" />
                                        <field name="MemberType" type="string" />
                                        <field name="Role" type="string" />
                                        <field name="Npi" type="string" />
                                        <field name="IsActive" type="boolean" />
                                        <field name="IsPaid" type="boolean" />
                                        <field name="IsLocked" type="boolean" />
                                        <field name="IsRegistered" type="boolean" />
                                        <field name="DateLastLoggedIn" type="date" />
                                        <field name="DateLastLoggedInDisplay" type="string" />
                                        <field name="DateCreated" type="date" />
                                        <field name="DateCreatedDisplay" type="string" />
                                        <field name="DetailUrl" type="string" />
                                        <field name="EditActionUrl" type="string" />
                                        <field name="ChangePasswordModalUrl" type="string" />
                                        <field name="ToggleActiveModalUrl" type="string" />
                                        <field name="SendRegistrationEmailModalUrl" type="string" />
                                        <field name="UnlockActionUrl" type="string" />
                                        <field name="SettingsActionUrl" type="string" />
                                        <field name="CommunicationPreferencesActionUrl" type="string" />
                                    </fields>
                                </model>
                            </schema>
                            <transport>
                                <read url="@Url.RouteUrl("AdminMemberMembersDataSource")" type="POST" />
                            </transport>
                        </datasource>
                        <columns>
                            <column field="UserName" title="UserName" template="<a href='#=EditActionUrl#'>#=UserName#</a>">
                                <filterable enabled="true">
                                    <cell show-operators="false" operator="contains" />
                                </filterable>
                                <sortable enabled="true" />
                            </column>
                            <column field="MemberId" title="MemberId">
                                <filterable enabled="true">
                                    <cell show-operators="false" template="standardFilter" />
                                </filterable>
                                <sortable enabled="true" />
                            </column>
                            <column field="FirstName" title="First Name">
                                <filterable enabled="true">
                                    <cell show-operators="false" operator="contains" />
                                </filterable>
                                <sortable enabled="true" />
                            </column>
                            <column field="LastName" title="Last Name">
                                <filterable enabled="true">
                                    <cell show-operators="false" operator="contains" />
                                </filterable>
                                <sortable enabled="true" />
                            </column>
                            <column field="Email" title="Email">
                                <filterable enabled="true">
                                    <cell show-operators="false" operator="contains" />
                                </filterable>
                                <sortable enabled="false" />
                            </column>
                            <column field="MemberTypeId" title="Occupation" template="#= MemberType #">
                                <filterable enabled="true">
                                    <cell show-operators="false" template="occupationFilter" />
                                </filterable>
                                <sortable enabled="false" />
                            </column>
                            <column field="Role" title="Role">
                                <filterable enabled="true">
                                    <cell show-operators="false" template="roleFilter" />
                                </filterable>
                                <sortable enabled="false" />
                            </column>
                            <column field="Npi" title="NPI">
                                <filterable enabled="true">
                                    <cell show-operators="false" />
                                </filterable>
                                <sortable enabled="true" />
                            </column>
                            <column field="IsActive" title="Active" template="<i class='far # if (IsActive) { #fa-check-square# } else { #fa-square# }#'></i>">
                                <filterable enabled="true">
                                    <cell show-operators="false" template="boolFilter" />
                                </filterable>
                                <sortable enabled="true" />
                            </column>
                            <column field="IsPaid" title="Paid" template="<i class='far # if (IsPaid) { #fa-check-square# } else { #fa-square# }#'></i>">
                                <filterable enabled="true">
                                    <cell show-operators="false" template="boolFilter" />
                                </filterable>
                                <sortable enabled="true" />
                            </column>
                            <column field="IsRegistered" title="Registered" template="<i class='far # if (IsRegistered) { #fa-check-square# } else { #fa-square# }#'></i>">
                                <filterable enabled="true">
                                    <cell show-operators="false" template="boolFilter" />
                                </filterable>
                                <sortable enabled="true" />
                            </column>
                            <column field="DateLastLoggedIn" title="Last Login" template="#= DateLastLoggedInDisplay #">
                                <filterable enabled="false">
                                    <cell show-operators="false" />
                                </filterable>
                                <sortable enabled="true" />
                            </column>
                            <column field="DateCreated" title="Created" template="#= DateCreatedDisplay #">
                                <filterable enabled="false">
                                    <cell show-operators="false" />
                                </filterable>
                                <sortable enabled="true" />
                            </column>
                            <column title="Actions">
                                <commands>
                                    <column-command name="Settings" click="EditSettings" template="<a title='Edit Settings' class='k-grid-Settings p-1'><i class='fas fa-cog'></i></a>" />
                                    <column-command name="CommunicationPreferences" click="CommunicationPreferences" visible="CommunicationPreferencesDisplay" template="<a title='Edit Communication Preferences' class='k-grid-CommunicationPreferences p-1'><i class='fas fa-envelope'></i></a>" />
                                    <column-command name="Unlock" click="Unlock" visible="UnlockDisplay" template="<a title='Unlock Account' class='k-grid-Unlock p-1'><i class='fas fa-lock-alt'></i></a>" />
                                    <column-command name="Deactivate" click="Deactivate" visible="DeactivateDisplay" template="<a title='Deactivate Account' class='k-grid-Deactivate p-1'><i class='fas fa-power-off'></i></a>" />
                                    <column-command name="ChangePassword" click="ChangePassword" visible="ChangePasswordDisplay" template="<a title='Reset Password' class='k-grid-ChangePassword p-1'><i class='fas fa-key'></i></a>" />
                                    <column-command name="SendRegistrationEmail" click="SendRegistrationEmail" visible="SendRegistrationEmailDisplay" template="<a title='Send Registration Email' class='k-grid-SendRegistrationEmail p-1'><i class='fas fa-address-card'></i></a>" />
                                </commands>
                            </column>
                        </columns>
                        <filterable mode="row" extra="false" />
                        <pageable enabled="true" page-sizes-enabled="true" page-size="20" page-sizes="new int[] { 10, 20, 30, 50 }" />
                        <sortable enabled="true" />
                        <column-menu enabled="true" filterable="false" />
                        <excel all-pages="true" filterable="true" file-name="Users.xlsx" />
                    </kendo-grid>
                </div>
            </div>
        </div>
    </section>
    <partial name="_AddEntityToOrganizationDialog" model="Model.AddDialog" />
    <div id="ModalContainer">
    </div>
    <script id="MemberDetail" type="text/html">
        <div class="text-center">
            <i class="far fa-spinner fa-spin fa-2x"></i>
        </div>
    </script>
    <script type="text/javascript">
        function onDetailInit(e) {
            e.detailCell.load(e.data.DetailUrl);
        }

        function Deactivate(e) {
            e.preventDefault();
            LoadingPanel.loader.show();
            $("#ModalContainer").load($("#Members").data("kendoGrid").dataItem($(e.currentTarget).closest("tr")).ToggleActiveModalUrl);
        }

        function DeactivateDisplay(dataItem) {
            return dataItem.IsActive;
        }

        function ChangePassword(e) {
            e.preventDefault();
            $("#ModalContainer").load($("#Members").data("kendoGrid").dataItem($(e.currentTarget).closest("tr")).ChangePasswordModalUrl);
        }

        function Unlock(e) {
            let grid = $("#Members").data("kendoGrid"),
                actionUrl = grid.dataItem($(e.currentTarget).closest("tr")).UnlockActionUrl;

            e.preventDefault();
            $.post({
                "url": actionUrl,
                "success": function () {
                    grid.dataSource.fetch();
                }
            });
        }

        function EditSettings(e) {
            e.preventDefault();
            window.open($("#Members").data("kendoGrid").dataItem($(e.currentTarget).closest("tr")).SettingsActionUrl, "_blank");
        }

        function CommunicationPreferences(e) {
            e.preventDefault();
            window.open($("#Members").data("kendoGrid").dataItem($(e.currentTarget).closest("tr")).CommunicationPreferencesActionUrl, "_blank");
        }

        function UnlockDisplay(dataItem) {
            return dataItem.IsLocked;
        }

        function CommunicationPreferencesDisplay(dataItem) {
            return dataItem.IsActive;
        }

        function SendRegistrationEmailDisplay(dataItem) {
            return dataItem.IsActive && !dataItem.IsRegistered;
        }

        function ChangePasswordDisplay(dataItem) {
            return dataItem.IsActive && dataItem.IsRegistered;
        }

        function SendRegistrationEmail(e) {
            e.preventDefault();
            $("#ModalContainer").load($("#Members").data("kendoGrid").dataItem($(e.currentTarget).closest("tr")).SendRegistrationEmailModalUrl);
        }

        function standardFilter(e) {
            e.element.kendoTextBox();
        }

        function boolFilter(e) {
            let field = e.element.parents("[data-field]").attr("data-field"),
                dataSource = (function () {
                    switch (field) {
                        case "IsActive":
                            return [{ "Text": "Active", "Value": true }, { "Text": "Inactive", "Value": false }];
                        case "IsPaid":
                            return [{ "Text": "Paid", "Value": true }, { "Text": "Unpaid", "Value": false }];
                        case "IsRegistered":
                            return [{ "Text": "Registered", "Value": false }, { "Text": "Unregistered", "Value": true }];
                    }
                })();

            e.element.kendoDropDownList({
                "dataSource": dataSource,
                "dataValueField": "Value",
                "dataTextField": "Text"
            });
        }

        function occupationFilter(e) {
            e.element.kendoDropDownList({
                "dataSource": new kendo.data.DataSource({
                    "data": @Html.Raw(Json.Serialize(Model.MemberTypes))
                                                                    }),
                "dataValueField": "Key",
                "dataTextField": "Value",
                "valuePrimitive": true
            });
        }

        function roleFilter(e) {
            e.element.kendoDropDownList({
                "dataSource": new kendo.data.DataSource({
                    "data": @Html.Raw(Json.Serialize(Model.Roles))
                                                                    }),
                "dataValueField": "Key",
                "dataTextField": "Value",
                "valuePrimitive": true
            });
        }

        function AddMemberDialogConfirm(e) {
            let orgData = $("#@Model.AddDialog.OrganizationFieldName").data("kendoComboBox").dataItem();

            if (!orgData) {
                return false;
            }

            window.location.href = orgData.CreateMemberUrl;
        }

        function onOrganizationFilterChange(e) {
            let dataSource = $("#Members").data("kendoGrid").dataSource,
                filters = dataSource.filter() ? dataSource.filter().filters.filter(function (item) { return item.field !== "OrganizationId" }) : [];

            if (this.select() >= 0) {
                filters.push({
                    "field": "OrganizationId",
                    "operator": "contains",
                    "value": this.value()
                });
            }
            else {
                this.value("");
            }

            $("#Members").data("kendoGrid").dataSource.filter(filters);
        }

        $(document).ready(function () {
            $("#AddNewMember").click(function () {
                $("#@Model.AddDialog.DialogName").data("kendoDialog").open();
            });

            $("#ExcelExport").click(function () {
                $("#Members").data("kendoGrid").saveAsExcel();
            });

            $(document).on("@SutureHealth.AspNetCore.Areas.Admin.Models.Member.ToggleActiveModel.EVENT_ACTIVATION_CHANGED", function () {
                $("#Members").data("kendoGrid").dataSource.fetch();
            });
        });
    </script>